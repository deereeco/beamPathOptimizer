BEAM PATH OPTIMIZER - VERSION LOG
================================================================================

Version 1.8 (2025-12-05)
--------------------------------------------------------------------------------
Breaking Changes:

  • Optimizer System - REMOVED
    - Removed entire optimization system due to reliability issues
    - Includes simulated annealing algorithm (Optimizer.js)
    - Includes cost function calculations (CostFunction.js)
    - Includes results view with graph visualization (ResultsGraph.js)
    - Feature was not working reliably and could break the application
    - Will be re-implemented in a future version with more careful design

    What was removed:
    - Optimizer UI controls (weight sliders, start/pause/stop buttons)
    - Progress tracking and statistics display
    - Snapshot storage and preview functionality
    - Cost vs iteration graph with interactive selection
    - Split-screen comparison mode
    - Results view panel
    - "Optimize" button and optimizer toggle interface
    - All optimizer-related CSS styling (~200 lines)

    What remains:
    - Fixed Position and Fixed Angle checkboxes (no longer reference optimizer)
    - Alignment Constraints (V/H/U keys) fully functional
    - All other features remain unchanged

    Alternative:
    - Users can manually arrange components as needed
    - Use Alignment Constraints (V/H keys) for persistent component relationships
    - Fixed Position/Angle checkboxes provide manual control

Files Modified:

  • js/main.js
    - Removed optimizer import
    - Removed optimizer instance variable
    - Removed results view state variables
    - Removed setupOptimizerControls() method (~100 lines)
    - Removed all optimizer control methods (~520 lines total):
      * startOptimization, pauseOptimization, resumeOptimization
      * stopOptimization, acceptOptimization, revertOptimization
      * updateOptimizerProgress, onOptimizationComplete
      * showOptimizerSection, hideOptimizerSection
      * getOptimizationWeights, showOptimizerButtons
      * openResultsView, closeResultsView
      * previewSelectedSnapshot, applySelectedSnapshot
      * setupResultsViewControls
    - Cleaned up ~520 lines of optimizer code

  • index.html
    - Removed optimizer section (~60 lines)
    - Removed results view section (~30 lines)
    - Removed optimizer toggle button
    - Removed checkbox hints referencing optimizer
    - Cleaned up ~95 lines of UI code

  • css/styles.css
    - Removed optimizer controls styling
    - Removed results view styling
    - Removed split-screen comparison styles
    - Removed preview mode indicator styles
    - Removed optimizer toggle button styles
    - Cleaned up ~200 lines of CSS

  • js/state.js
    - Version bumped to 1.8

Files Deleted:

  • js/optimization/ directory (1,680 lines total)
    - Optimizer.js (1,144 lines) - Simulated annealing implementation
    - CostFunction.js (536 lines) - Cost calculations and penalties

  • js/render/ResultsGraph.js
    - Results graph visualization (referenced but not counted above)

Documentation Updated:

  • claude.md - Added Phase 10 section documenting removal, updated Overview, removed
    "Optimization" feature section, removed "Optimization Algorithm Details" section,
    updated File Structure to remove optimization directory
  • versionlog.txt - Added V1.8 changelog

Total Impact:
  • Over 2,100 lines of code removed across 4 files
  • 1 directory completely deleted (optimization/)
  • Simplified codebase for better maintainability
  • Alignment constraints remain fully functional
  • Manual component arrangement still fully supported

================================================================================

Version 1.7 (2025-12-05)
--------------------------------------------------------------------------------
Breaking Changes:

  • Path Length Constraints - REMOVED
    - Removed entire path length constraint system due to complexity and instability
    - Includes manual fold-based constraints (L-shape and U-shape)
    - Includes automatic fold geometry calculations (FoldGeometry.js)
    - Includes fixed input/output/reflected distance constraints
    - Feature was not working reliably and could break the application
    - Will be re-implemented in a future version with more careful design

    What was removed:
    - Path length constraint creation and management UI
    - Fold count controls (0/1/2 folds)
    - Automatic mirror creation/removal for folds
    - Synchronized movement of constrained components
    - Mirror dragging to maintain path lengths
    - Fixed distance constraints for lenses and beam splitters
    - Path length validation during component movement
    - Fold geometry rendering and visualization

    Alternative:
    - Users can still use Alignment Constraints (V/H keys) for persistent
      component relationships that move together

Files Modified:

  • js/state.js
    - Version bumped to 1.7
    - Removed FoldGeometry import
    - Removed validatePathLengthConstraints() function
    - Removed recalculateLensPositionFromMirror() function
    - Removed recalculateMirrorPositionsFromLens() function
    - Removed path length validation from UPDATE_COMPONENT reducer
    - Removed fold constraint logic from MOVE_COMPONENT reducer (~300 lines)
    - Removed fold constraint logic from ROTATE_CONSTRAINED_PAIR reducer
    - Removed path length constraint cleanup from DELETE_COMPONENT reducer
    - Simplified component movement logic

  • js/models/Component.js
    - Removed pathConstraints property (enabled, inputDistance, outputDistance, reflectedDistance)
    - Removed pathLengthConstraints array property
    - Updated constructor to exclude removed properties
    - Updated toJSON() serialization to exclude removed properties
    - Updated update() whitelist to exclude removed properties

  • index.html
    - Removed Path Constraints UI section (~50 lines)
    - Removed enable checkbox
    - Removed input/output/reflected distance controls
    - Removed path length constraints list
    - Removed "Add Path Length Constraint" button

  • js/render/Renderer.js
    - Removed drawFoldGuides() method (~105 lines)
    - Removed fold guide rendering from main render loop
    - Removed fold geometry visualization
    - Removed path length constraint status indicators

  • js/main.js
    - Removed path constraint UI bindings (~100 lines)
    - Removed createPathLengthConstraint() method
    - Removed removePathLengthConstraint() method
    - Removed changeFoldCount() method
    - Removed updateMirrorsForConstraint() method
    - Removed calculateOneFoldGeometry() method
    - Removed calculateTwoFoldGeometry() method
    - Removed rotateConstraintSystemRigidBody() method
    - Removed path constraint properties panel updates
    - Removed path length constraints list rendering
    - Removed fold constraint checks from rotation logic
    - Removed fold constraint checks from drag operations
    - Removed segment fixed length assignment
    - Simplified component rotation to basic angle update

Files Deleted:

  • js/physics/FoldGeometry.js (352 lines)
    - Automatic fold geometry calculation system
    - calculateFoldGeometry() function
    - Path length validation algorithms
    - L-shape and U-shape geometry calculations

Documentation Updated:

  • claude.md - Phase 9 section replaced with removal notice
  • README.md - Removed path length constraints section, updated version to 1.7
  • versionlog.txt - Added V1.7 changelog

Total Impact:
  • Over 1,100 lines of code removed across 6 files
  • 1 file completely deleted
  • Simplified codebase for better maintainability
  • Alignment constraints remain fully functional

================================================================================

Version 1.6 (2025-12-04)
--------------------------------------------------------------------------------
New Features:

  • Source Light Emission Control
    - New "Light Emission" property for source components
    - Checkbox: "Emit light when lasers on"
    - Allows disabling individual sources without removing them
    - Sources with emission disabled show red "X" overlay
    - Property saved/loaded with project files
    - Auto-propagates beams when toggled (if auto-propagate enabled)

Bug Fixes:

  • Fixed File Name Not Populating on Load
    - File name input now properly displays loaded document's name
    - Issue: Name typed in input wasn't synced to application state
    - Solution: Added bidirectional state synchronization with input field
    - File name in text box now matches what's saved in JSON
    - New UPDATE_DOCUMENT_NAME action added to state management

  • Fixed Beam Splitter Reflectance Property
    - Reflectance slider now actually affects beam behavior
    - Previously: Both reflected and transmitted beams always created (50/50)
    - Fixed: Only creates beams based on reflectance/transmittance values
    - 100% reflectance → only reflected beam shows
    - 0% reflectance (100% transmission) → only transmitted beam shows
    - 50/50 → both beams show (default)
    - Auto-propagates when reflectance changed (if auto-propagate enabled)

UI/UX Improvements:

  • Simplified Background Settings
    - Removed "Clear Image" button (redundant with color/image radio selection)
    - Removed "Reset to Default" button (unnecessary complexity)
    - Cleaner, more streamlined settings modal
    - Only essential controls remain: type selector, color picker, image chooser, opacity slider

Technical Changes:

  • Version bumped to 1.6
  • Component.emitLight property added (default: true for sources)
  • Component.update() whitelist includes emitLight
  • Component.toJSON() serializes emitLight
  • propagateBeamFrom() respects emitLight and reflectance/transmittance values
  • createBeamConnection() respects reflectance/transmittance for port selection
  • State management includes UPDATE_DOCUMENT_NAME action and reducer
  • File name input event listener syncs to state on input

Files Modified:
  • js/state.js - Version to 1.6, UPDATE_DOCUMENT_NAME action/reducer
  • js/models/Component.js - emitLight property, defaults, update whitelist, toJSON serialization
  • js/main.js - File name sync, emitLight controls, reflectance beam logic, auto-propagate on changes
  • js/render/Renderer.js - Red "X" overlay for disabled sources
  • index.html - Light emission checkbox, removed background buttons
  • css/styles.css - Simplified background controls layout
  • versionlog.txt - Added V1.6 changelog
  • claude.md - Updated documentation
  • README.md - Updated version and features

Version 1.5 (2025-12-04)
--------------------------------------------------------------------------------
New Features:

  • Persistent Alignment Constraints
    - Press V to align 2+ selected components vertically (same X coordinate)
    - Press H to align 2+ selected components horizontally (same Y coordinate)
    - Constraints persist when components are moved - all constrained components move together
    - Bidirectional constraints: moving any component in the group moves all others
    - Alignment Constraints displayed in properties panel with visual indicators
    - Each constraint shows type (↕ Vertical or ↔ Horizontal) and linked component name
    - Click × button to remove individual constraints
    - Press U key to remove ALL alignment constraints from selected component(s)
    - Constraints automatically cleaned up when components are deleted
    - Constraints saved/loaded with project files

  • Toast Notification System
    - Implemented comprehensive toast notification system
    - Color-coded by type: green (success), orange (warning), red (danger), blue (info)
    - Notifications appear at bottom center for 3 seconds
    - Used for alignment operations, constraint removal, and other user feedback
    - Replaces missing showToast() method that was causing console errors

Bug Fixes:

  • Fixed Background Image Persistence
    - Background images now properly save and restore when loading files
    - Images saved as data URLs (base64 encoded) in JSON
    - Previously only saved filename, causing black screen on reload
    - imageDataURL field added to background state
    - Image recreated from data URL when loading file

  • Fixed Component Deselection
    - Clicking on empty workspace now properly deselects all components
    - Visual highlights are correctly removed (not just properties panel)
    - Issue was stale state being used after clearSelection() dispatch
    - Fixed in both select mode and connect mode
    - Selection state now properly synchronized with render

  • Fixed Component.update() Array Handling
    - Arrays (like alignmentConstraints) are now properly copied
    - Previously treated arrays as objects, causing corruption
    - Added explicit Array.isArray() check before spreading
    - Prevents alignment constraints from becoming malformed

UI/UX Improvements:

  • Context-Aware V/H Keys
    - V key: Align vertically if 2+ selected, otherwise switch to select tool
    - H key: Align horizontally if 2+ selected, otherwise switch to pan tool
    - Smooth workflow without conflicting with tool shortcuts

  • Alignment Constraints UI Panel
    - New "Alignment Constraints" section in properties panel
    - Shows all constraints for selected component
    - Visual design with colored type indicators and component names
    - Remove buttons with hover effect for easy constraint management
    - "No alignment constraints" message when empty

Technical Changes:

  • Version bumped to 1.5
  • Component model extended with alignmentConstraints property (array)
  • Component.toJSON() now serializes alignmentConstraints
  • Component.update() whitelist includes alignmentConstraints
  • Component.update() properly handles arrays vs objects
  • MOVE_COMPONENT action enforces alignment constraints automatically
  • DELETE_COMPONENT action cleans up orphaned constraints
  • State management handles bidirectional constraint updates
  • Background state includes imageDataURL field for persistence
  • Toast notification system with type-based color coding

Files Modified:
  • js/state.js - Version to 1.5, MOVE_COMPONENT constraint enforcement, DELETE_COMPONENT cleanup
  • js/models/Component.js - alignmentConstraints property, array handling in update(), toJSON serialization
  • js/main.js - Alignment functions, unconstrain function, toast system, deselection fix, V/H/U key handlers, background image persistence
  • index.html - Alignment constraints UI section in properties panel
  • css/styles.css - Alignment constraint item styling with hover effects
  • claude.md - Updated keyboard shortcuts and features documentation
  • versionlog.txt - Added V1.5 changelog

Version 1.4 (2025-12-03)
--------------------------------------------------------------------------------
Bug Fixes:

  • Fixed Source Component Emission Direction
    - Removed manual emission direction control from properties panel
    - Beam direction now automatically determined by component's rotation angle
    - At 0°: beam travels right, 90°: down, 180°: left, 270°: up
    - The pointed end of source shape always indicates beam direction
    - Emission angle is now a computed getter property (returns component.angle)
    - More intuitive behavior - rotating the source rotates the beam

  • Fixed Beam Path Recalculation on Component Movement/Rotation
    - Beam segments now properly update when source components move or rotate
    - Added recalculateBeamSegmentsFromComponent() function in state reducer
    - Recalculates endpoint positions for beams going to workspace boundary
    - Triggered automatically on UPDATE_COMPONENT and MOVE_COMPONENT actions
    - Beams now translate with component (no unwanted rotation)
    - Beams now rotate correctly when component angle changes

  • Fixed Version Migration Dialog Issues (3 fixes)
    - Cancel button now properly stops file loading (doesn't load file)
    - Added two-step dialog: "Upgrade" → "Use old version" → "Cancel"
    - Added explicit option to load old file version without upgrading
    - Backup file automatically created with version suffix (e.g., "filename-V1.1.json")
    - Clear messaging about what each option does

  • Fixed Opacity Error When Loading Old Files
    - Added comprehensive state initialization for missing properties
    - Now properly loads: background, grid, wavelengths, UI settings
    - Prevents "Cannot read properties of undefined (reading 'opacity')" error
    - All state properties have proper defaults when loading legacy files

  • Fixed Version Format Consistency
    - Removed trailing ".0" from file version format
    - toFileFormat() now returns "1.4" instead of "1.4.0"
    - Display format consistent with file format (both show V1.4)
    - Removed need for regex stripping in display code
    - Backward compatible with old "1.x.0" format files

Technical Changes:

  • Version bumped to 1.4
  • Imported BeamPhysics and BeamSegment into state.js
  • Added helper functions: recalculateBeamSegmentsFromComponent(),
    findWorkspaceBoundaryIntersection(), lineIntersection()
  • Removed emissionAngle from Component.update() updatable properties
  • Converted emissionAngle to getter property in Component class
  • Enhanced saveDocument() to persist all state properties (grid, background, etc.)
  • Enhanced openDocument() to merge loaded state with defaults
  • Updated version migration workflow with better UX

Files Modified:
  • js/state.js - Version, beam recalculation functions, BeamPhysics import
  • js/models/Component.js - emissionAngle getter, removed from constructor/update
  • js/main.js - Version migration dialog, backup creation, state initialization
  • index.html - Removed emission direction dropdown
  • versionlog.txt - Added V1.4 changelog


Version 1.3 (2025-12-03)
--------------------------------------------------------------------------------
Bug Fixes:

  • Fixed Critical Background Rendering Bug
    - Background now properly fills entire workspace area
    - Previous: Background only rendered in center portion due to coordinate system mismatch
    - Fixed: Adjusted drawBackground() to use centered world coordinates (-width/2 to +width/2)
    - Issue was visible when using solid colors or background images

New Features:

  • Wavelength Management Modal
    - Replaced browser prompts with full-featured modal interface
    - Button now displays "Manage Wavelengths" text instead of gear icon
    - Add, edit, and delete custom wavelengths with visual color picker
    - List view shows all wavelengths with color swatches
    - Preset wavelengths cannot be deleted (protected)
    - HTML5 color picker for easy color selection (no hex codes needed)

  • Background Image Opacity Control
    - New opacity slider (0-100%) in Settings modal
    - Applies transparency to background images
    - Saved in state and persists across sessions
    - 0% = completely transparent, 100% = fully opaque

  • Grid Settings Relocated
    - Moved from left panel to floating button in top-right corner of canvas
    - Click grid icon (⚞) to open modal dialog
    - Cleaner left panel with more space for tools
    - Grid settings: enable/disable snap, adjust size (1-50mm)
    - Settings persist and sync with state

  • Default Background Reset Button
    - New "Reset to Default" button in Settings modal
    - Quickly revert to default dark background (#0d1117)
    - Clears any selected image or custom color
    - One-click restoration of original appearance

UI/UX Improvements:

  • Angle Range Limited to 0-180°
    - Input fields and sliders now constrained to 0-180° range
    - Components with angles >180° are normalized for display
    - Prevents confusion with angle wrapping
    - Simplifies angle input for users

  • Properties Pane Restructured (Left-Aligned Layout)
    - Changed from center-aligned to left-aligned with 12px padding
    - Labels on left, values on right for better readability
    - Each property gets its own visual row
    - Position and Size inputs stacked vertically for clarity
    - Example layout:
      ```
      Name:     [textbox]
      Type:     Waveplate
      Position: X [value] mm
                Y [value] mm
      ```

  • Left Panel Items Centered
    - All items in left panel sections now properly centered
    - Tool buttons, component palette, and controls aligned
    - More polished and professional appearance

  • Category Headers Emphasized
    - Section headers ("Navigation", "Beams", "Zones") are now bigger and bolder
    - Font size increased: 11px → 13px
    - Font weight increased: 600 → 700
    - Makes navigation hierarchy immediately obvious

Technical Changes:

  • Version bumped to 1.3
  • Background state extended with opacity property
  • Grid section removed from left panel HTML
  • New modal components: wavelength-modal, grid-modal
  • CSS updates for left-alignment, centering, and new modals
  • Floating button component added for canvas overlay UI
  • Wavelength CRUD operations: add, edit, delete with validation
  • Coordinate system fix in Renderer.drawBackground()


Version 1.2 (2025-12-03)
--------------------------------------------------------------------------------
New Features:

  • Multiple Wavelengths / Beam Colors
    - Select wavelength before adding beams (Beams section in left panel)
    - 6 preset wavelengths: 633nm HeNe, 532nm Nd:YAG, 1064nm IR, 405nm Violet, 780nm GaAs, 850nm VCSEL
    - Add custom wavelengths via gear button
    - Segments can have multiple colors (displayed as divided line segments)
    - Multi-color segments support for co-aligned beams

  • Workspace Background Settings
    - Settings button (gear icon) in toolbar
    - Choose solid color with color picker
    - Or select image file for background
    - Image path saved in JSON (falls back to color if not found)

  • Global Grid Settings
    - New "Grid" section in left panel
    - Toggle grid snapping on/off globally
    - Adjustable grid size slider (1mm - 50mm)
    - Updates visual grid and snap behavior

UI/UX Improvements:

  • Keyboard Shortcut: R Key Rotation
    - Press R to rotate selected component(s) 90° clockwise
    - Respects "Fixed Angle" setting - shows warning if angle is fixed
    - Works with multiple selection

  • Right Panel Improvements
    - All items centered for cleaner appearance
    - Draggable divider to resize panel width (180-400px)
    - Text size slider (80-150%) at top of panel
    - Settings persist in localStorage

  • Left Panel Restructured
    - "Tools" renamed to "Navigation" (Select, Pan)
    - New "Beams" section for beam tools and wavelength selection
    - Components, Zones, and Grid sections below

Technical:
  • Version bumped to 1.2
  • State extended with grid, background, and wavelengths
  • BeamSegment model supports wavelengthIds array
  • Multi-color segment rendering in Renderer


Version 1.1 (2025-12-02)
--------------------------------------------------------------------------------
UI/UX Improvements:
  • Added drag-and-drop for components from palette to canvas
    - Click and drag components from the left panel directly onto the canvas
    - Visual preview follows cursor while dragging
    - Green border and coordinate indicator when over canvas
    - Shows grid-snapped position where component will be placed
    - Makes grid snapping immediately apparent to users

  • Fixed component proportions in palette
    - Waveplate and Filter icons now display as thin rectangles (matching mirrors)
    - Previously displayed as squares which was misleading
    - All palette icons now accurately represent their actual component shapes

  • Updated default component sizes for accuracy
    - Waveplate: changed from 20×20mm (square) to 20×5mm (rectangle)
    - Filter: changed from 20×20mm (square) to 20×5mm (rectangle)
    - Beam splitters and detectors remain square as physically accurate
    - Mirrors, lenses, and waveplates/filters now display as rectangles

User Experience:
  • Component buttons now show grab cursor (hand) to indicate draggability
  • Removed confusing two-click placement workflow
  • Keyboard shortcuts still work for quick component placement


Version 1.0 (Initial Release)
--------------------------------------------------------------------------------
Core Features:
  • HTML5 Canvas-based optical table designer
  • 7 component types: Source, Mirror, Beam Splitter, Lens, Waveplate, Filter, Detector
  • Interactive beam path visualization with color coding
  • Pan (shift+drag/middle mouse) and zoom (scroll wheel)
  • Grid background with 25mm snap

Component Management:
  • Click-to-place components (deprecated in v1.1)
  • Drag to reposition components
  • Component property editing panel
  • Multi-select with Ctrl+click or drag selection box
  • Fixed position/angle locks for optimization

Beam Path System:
  • "Add Beams" tool for connecting components
  • Automatic beam physics (reflection, transmission)
  • Beam splitters create reflected and transmitted paths
  • Color coding by branch level (red → orange → yellow → green)
  • Line thickness represents beam power
  • Direction arrows on segments
  • Segment selection and deletion

Constraints & Zones:
  • Keep-out zones (areas where components cannot be placed)
  • Mounting zone (target area for center of mass)
  • Per-component mount zones with X/Y padding and offset
  • Visual feedback for constraint violations

Center of Mass Tracking:
  • Real-time CoM calculation weighted by component mass
  • Crosshair display on canvas
  • Status bar shows if CoM is inside mounting zone

Optimization (Simulated Annealing):
  • Adaptive parameters based on component count
  • Cost function: CoM distance, footprint, path length, violations
  • Constrained moves preserve relative beam angles
  • Fixed angle mode for components
  • Beam collision detection and penalties
  • Progress tracking: iteration count, improvement %, violations
  • Pause/Resume/Accept/Revert workflow

Results View Mode:
  • Cost vs iteration graph with interactive selection
  • Hover to see iteration details
  • Click/double-click to preview any iteration's layout
  • Split-screen comparison mode (original vs selected)
  • Apply any iteration, not just the best
  • Snapshot storage every 10 iterations

File Management:
  • Save to JSON (full state serialization)
  • Load from JSON with version checking
  • Migration prompts for older file formats
  • Unsaved changes warnings

Undo/Redo:
  • Full history stack for all state changes
  • Ctrl+Z / Ctrl+Y keyboard shortcuts

Beam Physics:
  • Default angles: 0° for transmission optics, 45° for mirrors
  • Source emission direction control
  • Shallow angle mode for beam splitters
  • Movement constraints to prevent breaking beam angles
  • Automatic angle snapping to valid values

Keyboard Shortcuts:
  • V: Select tool
  • H: Pan tool
  • C: Connect beam tool
  • M: Place mirror
  • S: Place source (Ctrl+S saves)
  • Delete/Backspace: Delete selected
  • Escape: Clear selection
  • Ctrl+Z: Undo
  • Ctrl+Y: Redo
  • +/-: Zoom in/out

Status Bar:
  • Center of Mass position
  • Mount zone status (OK/OUTSIDE/Not defined)
  • Violation count
  • Component count
  • Zoom level
  • Cursor position in workspace coordinates

Version Tracking:
  • Version badge displayed in top left toolbar
  • File format versioning for compatibility
  • Version comparison utilities for migration detection

# Beam Path Optimizer - Feature Implementation Plan (V1.2)

## Overview
This plan covers implementation of 5 new feature areas for the Beam Path Optimizer application.

---

## Feature 1: Workspace Background

### Requirements
- User can change workspace background to solid color (from palette) or image file
- JSON saves image path (not embedded), falls back to default black + warning if not found

### Implementation

**Files to Modify:**
- `js/state.js` - Add `workspace.background` to state
- `js/render/Renderer.js` - Render background before grid
- `js/main.js` - Add UI handlers for background controls
- `index.html` - Add background controls to UI (likely in a new Settings modal or toolbar)
- `css/styles.css` - Color picker and file input styling

**State Changes:**
```javascript
workspace: {
  width: 600,
  height: 600,
  background: {
    type: 'color' | 'image',
    color: '#0d1117',        // default canvas-bg
    imagePath: null,
    imageData: null          // runtime only, not saved
  }
}
```

**JSON Save/Load:**
- Save only `type`, `color`, and `imagePath`
- On load: attempt to load image, show toast warning if not found

**UI Location:** Settings gear icon in toolbar → opens modal with background options

---

## Feature 2: Global Grid Settings

### Requirements
- Toggle grid snapping on/off globally
- Slider + text input for grid size (1mm - 50mm)

### Implementation

**Files to Modify:**
- `js/state.js` - Add `grid.enabled` and `grid.size` to state
- `js/physics/BeamPhysics.js` - Use global grid size instead of hardcoded 25mm
- `js/render/Renderer.js` - Use state grid size for rendering
- `js/main.js` - Add UI handlers
- `index.html` - Add grid controls section to left panel (below Zones)
- `css/styles.css` - Styling for grid controls

**State Changes:**
```javascript
grid: {
  enabled: true,
  size: 25  // mm, range 1-50
}
```

**UI Location:** New "Grid" section in left panel below "Zones"

---

## Feature 3: Keyboard Shortcut - Rotate Component

### Requirements
- Press `R` to rotate selected component by 90 degrees clockwise

### Implementation

**Files to Modify:**
- `js/main.js` - Add keydown handler for 'R' key

**Logic:**
1. Check if exactly one component is selected
2. Get current angle
3. Add 90 degrees (wrap at 360)
4. Dispatch UPDATE_COMPONENT action with new angle
5. Respect `isAngleFixed` property - show toast if fixed

**Edge Cases:**
- Multiple selection: rotate all selected components
- No selection: no-op
- Fixed angle: show warning toast

---

## Feature 4: Multiple Wavelengths (Beam Colors)

### Requirements
- User can select beam color when adding beams
- Segments can have multiple colors (colinear, equally divided)
- "Choose Wavelengths" menu with presets + custom options
- New "Beams" section in left toolbar (move "Add Beams" there)
- Rename "Tools" section to "Navigation"

### Implementation

**Files to Modify:**
- `js/state.js` - Add `wavelengths` array to state, segment color properties
- `js/models/BeamPath.js` - Update BeamSegment to support `colors[]` array
- `js/render/Renderer.js` - Render multi-color segments
- `js/main.js` - Wavelength UI handlers, segment color editing
- `index.html` - Restructure left panel, add wavelength controls
- `css/styles.css` - Wavelength selector styling

**State Changes:**
```javascript
wavelengths: [
  { id: 'w1', name: '633nm HeNe', color: '#ff0000' },
  { id: 'w2', name: '532nm Nd:YAG', color: '#00ff00' },
  { id: 'w3', name: '1064nm IR', color: '#ff00ff' },
  { id: 'w4', name: '405nm Violet', color: '#8800ff' },
  // User can add custom
]

// BeamSegment update:
segment.colors = ['w1', 'w2']  // array of wavelength IDs
```

**Default Presets:**
- 633nm HeNe Red (#ff0000)
- 532nm Nd:YAG Green (#00ff00)
- 1064nm Nd:YAG IR (#ff00ff - visible representation)
- 405nm Violet Diode (#8800ff)
- 780nm GaAs Near-IR (#cc0044)
- 850nm VCSEL (#990066)

**Multi-Color Rendering:**
When segment has multiple colors, draw sequential colored sections:
```
|--red--|--green--|--blue--|  (3 colors = 3 equal segments)
```

**UI Structure (Left Panel):**
```
Navigation (renamed from Tools)
├── Select
├── Pan

Beams (new section)
├── Add Beams (tool)
├── [Wavelength selector dropdown]
├── "Choose Wavelengths" button → opens modal

Components
├── Source, Mirror, etc.

Zones
├── Keep-Out, Mount Zone

Grid (new)
├── Enable/Disable toggle
├── Size slider
```

**Wavelength Modal:**
- List of defined wavelengths with color swatches
- Add new wavelength (name + color picker)
- Edit existing wavelength
- Delete custom wavelengths (presets can't be deleted, only hidden)

---

## Feature 5: Right Pane Visibility Improvements

### Requirements
- Center all items in right pane (not left-aligned)
- Draggable divider between right and center panes
- Adjustable text size via slider (80%-150%)

### Implementation

**Files to Modify:**
- `css/styles.css` - Center alignment, resize handle styling
- `js/main.js` - Draggable divider logic, text size handlers
- `index.html` - Add resize handle element, text size slider

**CSS Changes:**
```css
#properties-panel {
  text-align: center;
}
.property-group {
  text-align: center;
}
.property-group label {
  text-align: center;
  display: block;
}
/* Inputs stay left-aligned for usability */
```

**Draggable Divider:**
- Add `<div class="panel-resize-handle">` between canvas and right panel
- Handle mousedown → track mousemove → update `--panel-width` CSS variable
- Min width: 180px, Max width: 400px
- Save preference to localStorage

**Text Size Slider:**
- Location: Top of right panel or Settings modal
- Range: 80% to 150%
- Updates `font-size` on `#properties-panel` via CSS variable
- Save preference to localStorage

---

## Implementation Order (Recommended)

### Phase 1: Quick Wins
1. **Keyboard shortcut (R key)** - Simple, isolated change
2. **Right pane centering** - CSS-only change
3. **Rename "Tools" to "Navigation"** - Simple HTML change

### Phase 2: Grid Settings
4. **Global grid settings** - State + UI + BeamPhysics integration

### Phase 3: UI Enhancements
5. **Draggable divider** - Interactive UI feature
6. **Text size slider** - CSS variable + localStorage

### Phase 4: Major Features
7. **Workspace background** - Settings modal + renderer changes
8. **Multiple wavelengths** - Largest feature, needs careful implementation:
   - a. Add wavelength state and presets
   - b. Restructure left panel (Beams section)
   - c. Wavelength selection during beam creation
   - d. Multi-color segment rendering
   - e. Wavelength modal for customization
   - f. Edit segment colors after creation

---

## Files Summary

| File | Changes |
|------|---------|
| `index.html` | Restructure left panel, add controls, wavelength modal |
| `css/styles.css` | Right pane centering, divider, wavelength UI, settings modal |
| `js/state.js` | Grid state, wavelength state, background state |
| `js/main.js` | All UI handlers, divider logic, keyboard shortcuts |
| `js/models/BeamPath.js` | Multi-color segment support |
| `js/render/Renderer.js` | Multi-color rendering, background rendering |
| `js/physics/BeamPhysics.js` | Use configurable grid size |

---

## Version Update
After implementation: Bump `APP_VERSION` to 1.2 in `js/state.js`
